"""Unit tests for {{ bot_name }} handlers."""

import sys
from pathlib import Path
from unittest.mock import AsyncMock, MagicMock, patch

import pytest

# Ensure project root is in path
sys.path.insert(0, str(Path(__file__).resolve().parent.parent))


@pytest.fixture
def mock_update():
    update = MagicMock()
    update.effective_user.id = 12345
    update.message.text = "Hello, bot!"
    update.message.reply_text = AsyncMock()
    return update


@pytest.fixture
def mock_context():
    return MagicMock()


@pytest.mark.asyncio
async def test_start_command(mock_update, mock_context):
    from bot.handler import start_command
    await start_command(mock_update, mock_context)
    mock_update.message.reply_text.assert_called_once()
    call_text = mock_update.message.reply_text.call_args[0][0]
    assert "{{ bot_name }}" in call_text


@pytest.mark.asyncio
async def test_help_command(mock_update, mock_context):
    from bot.handler import help_command
    await help_command(mock_update, mock_context)
    mock_update.message.reply_text.assert_called_once()
    call_text = mock_update.message.reply_text.call_args[0][0]
    assert "/start" in call_text
    assert "/help" in call_text


{% if "echo" in features %}
@pytest.mark.asyncio
async def test_echo_message(mock_update, mock_context):
    from bot.handler import echo_message
    await echo_message(mock_update, mock_context)
    mock_update.message.reply_text.assert_called_once_with("Hello, bot!")
{% endif %}


def test_setup_handlers():
    from bot.handler import setup_handlers
    app = MagicMock()
    setup_handlers(app)
    assert app.add_handler.called
    assert app.add_handler.call_count >= 2  # at least /start and /help
